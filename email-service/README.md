# Gmail Reminder Service for AutoRemind

This service sends automated Gmail reminders to students about pending assignments using the Gmail API. It reads message request CSV files (generated by the gradesync_input pipeline) and sends personalized reminder emails.

## Features

- Reads message request CSV files from the `message_requests/` directory
- Sends friendly, personalized reminder emails via Gmail API
- Handles multiple CSV files automatically
- Comprehensive logging of all operations
- No database dependencies - all filtering is done upstream

## Setup

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

### 2. Configure Environment Variables

Create a `.env` file or set the following environment variables:

```bash
# Gmail Configuration (optional, defaults provided)
export GMAIL_CREDENTIALS_PATH="config/credentials.json"
export GMAIL_SENDER_EMAIL="autoremind@yourdomain.com"

# Message Requests Directory (optional, defaults to "message_requests")
export MESSAGE_REQUESTS_DIR="message_requests"
```

### 3. Google Cloud Service Account Setup

1. Create a Google Cloud Project (if you don't have one)
2. Enable the Gmail API
3. Create a Service Account
4. Download the service account credentials JSON file
5. Place it in `config/credentials.json` (or set `GMAIL_CREDENTIALS_PATH`)

**Important**: The service account must be authorized to send emails from `autoremind@yourdomain.com`:
- In Google Workspace Admin, enable domain-wide delegation for the service account
- Grant the service account permission to send emails on behalf of the sender email

### 4. Message Request Files

The service reads CSV files from the `message_requests/` directory. These files are generated by the `gradesync_input` pipeline, which already performs all database checks and filtering.

**Expected CSV format:**
- `email` (required): Student email address
- `assignment` (required): Assignment name
- `name` or `first name`/`last name`: Student name
- `sid`: Student ID (optional, used as fallback for name)
- `message_requests`: Original message text (not used, but kept for reference)

## Usage

### Run the Service

```bash
python main.py
```

The service will:
1. Scan the `message_requests/` directory for CSV files
2. Process each CSV file
3. Send reminders to all students in the files
4. Log all operations to `gmail_reminder.log` and console

### Example Output

```
2024-01-15 10:00:00 - INFO - Starting Gmail Reminder Service for AutoRemind
2024-01-15 10:00:01 - INFO - Found 3 message request file(s)
2024-01-15 10:00:02 - INFO - Processing file: message_requests_Project 1.csv
2024-01-15 10:00:02 - INFO - Found 25 students in message_requests_Project 1.csv
2024-01-15 10:00:05 - INFO - âœ“ Sent reminder to student@example.com for Project 1
...
2024-01-15 10:00:30 - INFO - Emails sent: 75
2024-01-15 10:00:30 - INFO - Emails skipped: 0
2024-01-15 10:00:30 - INFO - Errors: 0
```

## File Structure

```
email-service/
â”œâ”€â”€ main.py                 # Main orchestration script
â”œâ”€â”€ gmail_service.py        # Gmail API functions
â”œâ”€â”€ requirements.txt        # Python dependencies
â”œâ”€â”€ README.md              # This file
â”œâ”€â”€ message_requests/      # CSV files with student data
â”‚   â”œâ”€â”€ message_requests_Project 1.csv
â”‚   â””â”€â”€ message_requests_Project 2.csv
â””â”€â”€ config/
    â””â”€â”€ credentials.json   # Google service account credentials (not in repo)
```

## Functions

### `format_resources(resources)`
Formats a list of resource links into a bulleted string.

### `send_gmail_reminder(student_email, student_name, assignment_name, ...)`
Sends a Gmail reminder to a student.

## Email Format

**Subject**: `Reminder: [assignment_name] is due soon!`

**Body**:
```
Hi [student_name],

You still have "[assignment_name]" pending. Here are some resources that might help:
- [link1]
- [link2]

You've got this! ðŸ’ª

â€“ The AutoRemind Team
```

## Error Handling

The service handles errors gracefully:
- Missing credentials â†’ Logs error and exits
- Gmail API errors â†’ Logs error and continues with next student
- Missing email addresses â†’ Skips student and logs warning
- All errors are logged to both file and console

## Logging

Logs are written to:
- `gmail_reminder.log` (file)
- Console/stdout

Log levels:
- `INFO`: Normal operations, successful sends
- `WARNING`: Non-fatal issues (e.g., missing email)
- `ERROR`: Failed operations

## Integration with gradesync_input

This service is designed to work with the `gradesync_input` pipeline:

1. The `gradesync_input` pipeline checks the database and filters students
2. It generates message request CSV files in `message_requests/`
3. This service reads those CSV files and sends Gmail reminders
4. No duplicate database checks needed

## Scheduling

To run this service automatically, you can:

1. **Cron** (Linux/Mac):
   ```bash
   # Run daily at 9 AM
   0 9 * * * cd /path/to/email-service && python main.py
   ```

2. **Systemd Timer** (Linux)

3. **Cloud Scheduler** (GCP/AWS)

4. **GitHub Actions** (with scheduled workflows)

## Troubleshooting

### "Credentials file not found"
- Check that `config/credentials.json` exists
- Or set `GMAIL_CREDENTIALS_PATH` environment variable

### "No CSV files found"
- Ensure message request CSV files exist in `message_requests/` directory
- Check that the `gradesync_input` pipeline has run successfully

### "Failed to send email"
- Verify service account has Gmail API enabled
- Check domain-wide delegation is configured
- Ensure sender email is authorized for service account

## License

Part of the AutoRemind project.


